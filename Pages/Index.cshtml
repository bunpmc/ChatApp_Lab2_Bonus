@page
@model IndexModel
@{
    ViewData["Title"] = "Premium Chat";
}

<!-- Username Modal -->
<div id="usernameModal" class="modal-overlay">
    <div class="modal-content">
        <h2>👋 Welcome to Chat</h2>
        <p>Enter your name to join the conversation.</p>
        <input type="text" id="usernameInput" placeholder="Your Name" value="Guest" autofocus />
        <button id="joinBtn" class="primary-btn">Join Chat</button>
    </div>
</div>

<div class="app-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>👥 Online Users</h3>
            <div id="userCount" class="badge">0</div>
        </div>
        <ul id="usersList" class="users-list">
            <!-- Users will appear here -->
        </ul>
    </div>

    <div class="chat-container">
        <div class="chat-header">
            <h1>✨ Razor SignalR Chat</h1>
            <div id="connectionStatus" class="status-indicator disconnected">Disconnected</div>
        </div>
        
        <div class="chat-messages" id="messagesList">
            <div class="message system">
                <div class="content">Welcome! Upload files 1GB+.</div>
            </div>
        </div>

        <div class="chat-input-area">
            <div class="preview-area" id="filePreviewArea" style="display:none;"></div>
            
            <div class="input-wrapper">
                <button id="emojiBtn" class="icon-btn">😀</button>
                <button id="fileBtn" class="icon-btn">📎</button>
                <input type="file" id="fileInput" multiple style="display: none;" />
                <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off" />
                <button id="sendBtn" class="send-btn">Send</button>
            </div>
            <!-- Z-index High to ensure it's on top -->
            <emoji-picker class="dark" style="display: none; position: absolute; bottom: 80px; left: 20px; z-index: 1000;"></emoji-picker>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="/js/signalr.min.js" onerror="scriptError('SignalR')"></script>
<script type="module" src="/js/emoji-picker-full.js" onerror="scriptError('Emoji Picker')"></script> 
<script>
    function scriptError(name) {
        const status = document.getElementById("connectionStatus");
        status.textContent = "Script Load Error: " + name;
        status.className = "status-indicator disconnected";
        console.error("Failed to load script: " + name);
    }

    // Constants
    const maxFileSize = 1024 * 1024 * 1024 * 2; // 2GB Client check

    // UI Elements
    const connectionStatus = document.getElementById("connectionStatus");
    const messagesList = document.getElementById("messagesList");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const fileBtn = document.getElementById("fileBtn");
    const fileInput = document.getElementById("fileInput");
    const emojiBtn = document.getElementById("emojiBtn");
    const emojiPicker = document.querySelector('emoji-picker');
    const usersList = document.getElementById("usersList");
    const userCount = document.getElementById("userCount");
    
    // Modal Elements
    const usernameModal = document.getElementById("usernameModal");
    const usernameInput = document.getElementById("usernameInput");
    const joinBtn = document.getElementById("joinBtn");

    // State
    let username = "";
    let connection = null;

    // 1. Handle Join Interaction
    joinBtn.addEventListener("click", () => {
        const val = usernameInput.value.trim();
        if (val) {
            username = val;
            joinBtn.disabled = true;
            joinBtn.textContent = "Connecting...";
            initChat(); 
        } else {
            alert("Please enter a username.");
        }
    });

    usernameInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") joinBtn.click();
    });

    // 2. Chat Initialization
    function initChat() {
        if (typeof signalR === 'undefined') {
            // Note: SignalR library usually uses global 'signalR' (capital R) or just adds to window
            // Let's check both
            if (typeof signalr === 'undefined') {
                connectionStatus.textContent = "Error: SignalR library not found on page";
                joinBtn.disabled = false;
                joinBtn.textContent = "Join Chat";
                return;
            }
        }
        
        const signalRInstance = (typeof signalR !== 'undefined') ? signalR : signalr;

        connection = new signalRInstance.HubConnectionBuilder()
            .withUrl("/chatHub")
            .withAutomaticReconnect()
            .configureLogging(signalRInstance.LogLevel.Information)
            .build();

        connection.onclose(async () => {
            connectionStatus.textContent = "Disconnected";
            connectionStatus.className = "status-indicator disconnected";
        });

        connection.onreconnected(async () => {
			connectionStatus.textContent = "Connected: " + username;
			connectionStatus.className = "status-indicator connected";
			await connection.invoke("JoinChat", username);
		});

		connection.onreconnecting(() => {
			connectionStatus.textContent = "Reconnecting...";
			connectionStatus.className = "status-indicator disconnected";
		});

        // Register events before starting
        connection.on("ReceiveMessage", (user, message) => addMessage(user, message));
        connection.on("ReceiveSystemMessage", (message) => addSystemMessage(message));
        connection.on("ReceiveFile", (user, fileName, fileUrl, fileType, fileSize) => addFileMessage(user, fileName, fileUrl, fileType, fileSize));
        connection.on("UpdateUserList", (users) => updateUserList(users));

        start();
    }

    async function start() {
        try {
            connectionStatus.textContent = "Connecting Hub...";
            await connection.start();
            connectionStatus.textContent = "Connected: " + username;
            connectionStatus.className = "status-indicator connected";
            usernameModal.style.display = 'none'; // Only hide modal if connection success
            await connection.invoke("JoinChat", username);
        } catch (err) {
            console.error(err);
            connectionStatus.textContent = "Connection Failed: " + (err.message || "Unknown Error");
            connectionStatus.className = "status-indicator disconnected";
            joinBtn.disabled = false;
            joinBtn.textContent = "Join Chat (Retry)";
        }
    }

    
    // Interactions
    sendBtn.addEventListener("click", async () => {
        if (!connection || connection.state !== "Connected") {
            alert("You are not connected.");
            return;
        }
        const msg = messageInput.value;
        if (msg.trim()) {
            try {
                await connection.invoke("SendMessage", username, msg);
                messageInput.value = "";
            } catch (err) {
                console.error(err);
            }
        }
    });

    messageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendBtn.click();
    });

    fileBtn.addEventListener("click", () => fileInput.click());

    fileInput.addEventListener("change", async (e) => {
        const files = e.target.files;
        if (files.length === 0) return;

        const formData = new FormData();
        for (let file of files) {
            formData.append("files", file);
        }
        
        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
        if (token) formData.append("__RequestVerificationToken", token);

        try {
            addSystemMessage("Uploading files...");
            const response = await fetch('?handler=Upload', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const result = await response.json();
                for (let item of result) {
                    await connection.invoke("SendFile", username, item.name, item.url, item.type, item.size);
                }
                addSystemMessage("Upload complete.");
            } else {
                addSystemMessage("Upload failed.");
            }
        } catch (err) {
            console.error(err);
            addSystemMessage("Upload error: " + err.message);
        }
        fileInput.value = "";
    });

    emojiBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent closing immediately
        emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
    });

    document.body.addEventListener('click', (e) => {
         if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
             emojiPicker.style.display = 'none';
         }
    });

    emojiPicker.addEventListener('emoji-click', event => {
        messageInput.value += event.detail.unicode;
        messageInput.focus();
    });

    // Helpers
    function updateUserList(users) {
        usersList.innerHTML = "";
        userCount.textContent = users.length;
        users.forEach(u => {
            const li = document.createElement("li");
            li.textContent = u === username ? `${u} (You)` : u;
            li.className = u === username ? "current-user" : "";
            usersList.appendChild(li);
        });
    }

    function addMessage(user, msg) {
        const div = document.createElement("div");
        div.className = `message ${user === username ? "self" : "other"}`;
        div.innerHTML = `
            <div class="user">${user}</div>
            <div class="content">${escapeHtml(msg)}</div>
        `;
        messagesList.appendChild(div);
        scrollToBottom();
    }

    function addSystemMessage(msg) {
        const div = document.createElement("div");
        div.className = "message system";
        div.innerHTML = `<div class="content">${msg}</div>`;
        messagesList.appendChild(div);
        scrollToBottom();
    }

    function addFileMessage(user, fileName, url, type, size) {
        const div = document.createElement("div");
        div.className = `message ${user === username ? "self" : "other"}`;
        
        let content = "";
        if (type.startsWith("image/")) {
            content = `<img src="${url}" alt="${fileName}" class="chat-image" />`;
        } else if (type.startsWith("video/")) {
            content = `<video src="${url}" controls class="chat-video"></video>`;
        } else {
             content = `<a href="${url}" target="_blank" class="file-link">📎 ${fileName} (${formatSize(size)})</a>`;
        }

        div.innerHTML = `<div class="user">${user}</div><div class="content">${content}</div>`;
        messagesList.appendChild(div);
        scrollToBottom();
    }

    function scrollToBottom() {
        messagesList.scrollTop = messagesList.scrollHeight;
    }

    function escapeHtml(text) {
        if (!text) return text;
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    function formatSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const types = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + types[i];
    }
</script>

@Html.AntiForgeryToken()
