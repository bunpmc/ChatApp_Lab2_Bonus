@page
@model IndexModel
@{
    ViewData["Title"] = "Premium Chat";
}

<!-- Username Modal -->
<div id="usernameModal" class="modal-overlay">
    <div class="modal-content">
        <h2>👋 Welcome to Chat</h2>
        <p>Enter your name to join the conversation.</p>
        <input type="text" id="usernameInput" placeholder="Your Name" value="Guest" autofocus />
        <button id="joinBtn" class="primary-btn">Join Chat</button>
    </div>
</div>

<div class="app-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>👥 Online Users</h3>
            <div id="userCount" class="badge">0</div>
        </div>
        <ul id="usersList" class="users-list">
            <!-- Users will appear here -->
        </ul>
    </div>

    <div class="chat-container">
        <div class="chat-header">
            <h1>✨ Razor SignalR Chat</h1>
            <div id="connectionStatus" class="status-indicator disconnected">Disconnected</div>
        </div>
        
        <div class="chat-messages" id="messagesList">
            <div class="message system">
                <div class="content">Welcome! Upload files 1GB+.</div>
            </div>
        </div>

        <div class="chat-input-area">
            <div class="preview-area" id="filePreviewArea">
                <div class="preview-header">
                    <span>📎 Files to send</span>
                    <button id="clearPreviewBtn" class="clear-btn">✕ Clear</button>
                </div>
                <div class="preview-items" id="previewItems"></div>
                <button id="sendFilesBtn" class="primary-btn">Send Files</button>
            </div>
            
            <div class="input-wrapper">
                <button id="emojiBtn" class="icon-btn">😀</button>
                <button id="fileBtn" class="icon-btn">📎</button>
                <input type="file" id="fileInput" multiple style="display: none;" />
                <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off" />
                <button id="sendBtn" class="send-btn">Send</button>
            </div>
            <!-- Z-index High to ensure it's on top -->
            <emoji-picker class="dark" style="display: none; position: absolute; bottom: 80px; left: 20px; z-index: 1000;"></emoji-picker>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="/js/signalr.min.js" onerror="scriptError('SignalR')"></script>
<script type="module" src="/js/emoji-picker-full.js" onerror="scriptError('Emoji Picker')"></script> 
<script>
    function scriptError(name) {
        const status = document.getElementById("connectionStatus");
        status.textContent = "Script Load Error: " + name;
        status.className = "status-indicator disconnected";
        console.error("Failed to load script: " + name);
    }

    // Constants
    const maxFileSize = 1024 * 1024 * 1024 * 2; // 2GB Client check

    // UI Elements
    const connectionStatus = document.getElementById("connectionStatus");
    const messagesList = document.getElementById("messagesList");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const fileBtn = document.getElementById("fileBtn");
    const fileInput = document.getElementById("fileInput");
    const emojiBtn = document.getElementById("emojiBtn");
    const emojiPicker = document.querySelector('emoji-picker');
    const usersList = document.getElementById("usersList");
    const userCount = document.getElementById("userCount");
    
    // Modal Elements
    const usernameModal = document.getElementById("usernameModal");
    const usernameInput = document.getElementById("usernameInput");
    const joinBtn = document.getElementById("joinBtn");

    // State
    let username = "";
    let connection = null;

    // 1. Handle Join Interaction
    joinBtn.addEventListener("click", () => {
        const val = usernameInput.value.trim();
        if (val) {
            username = val;
            joinBtn.disabled = true;
            joinBtn.textContent = "Connecting...";
            initChat(); 
        } else {
            alert("Please enter a username.");
        }
    });

    usernameInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") joinBtn.click();
    });

    // 2. Chat Initialization
    function initChat() {
        if (typeof signalR === 'undefined') {
            // Note: SignalR library usually uses global 'signalR' (capital R) or just adds to window
            // Let's check both
            if (typeof signalr === 'undefined') {
                connectionStatus.textContent = "Error: SignalR library not found on page";
                joinBtn.disabled = false;
                joinBtn.textContent = "Join Chat";
                return;
            }
        }
        
        const signalRInstance = (typeof signalR !== 'undefined') ? signalR : signalr;

        connection = new signalRInstance.HubConnectionBuilder()
            .withUrl("/chatHub")
            .withAutomaticReconnect()
            .configureLogging(signalRInstance.LogLevel.Information)
            .build();

        connection.onclose(async () => {
            connectionStatus.textContent = "Disconnected";
            connectionStatus.className = "status-indicator disconnected";
        });

        connection.onreconnected(async () => {
			connectionStatus.textContent = "Connected: " + username;
			connectionStatus.className = "status-indicator connected";
			await connection.invoke("JoinChat", username);
		});

		connection.onreconnecting(() => {
			connectionStatus.textContent = "Reconnecting...";
			connectionStatus.className = "status-indicator disconnected";
		});

        // Register events before starting
        connection.on("ReceiveMessage", (user, message) => addMessage(user, message));
        connection.on("ReceiveSystemMessage", (message) => addSystemMessage(message));
        connection.on("ReceiveFile", (user, fileName, fileUrl, fileType, fileSize) => addFileMessage(user, fileName, fileUrl, fileType, fileSize));
        connection.on("UpdateUserList", (users) => updateUserList(users));

        start();
    }

    async function start() {
        try {
            connectionStatus.textContent = "Connecting Hub...";
            await connection.start();
            connectionStatus.textContent = "Connected: " + username;
            connectionStatus.className = "status-indicator connected";
            usernameModal.style.display = 'none'; // Only hide modal if connection success
            await connection.invoke("JoinChat", username);
        } catch (err) {
            console.error(err);
            connectionStatus.textContent = "Connection Failed: " + (err.message || "Unknown Error");
            connectionStatus.className = "status-indicator disconnected";
            joinBtn.disabled = false;
            joinBtn.textContent = "Join Chat (Retry)";
        }
    }

    
    // Interactions
    sendBtn.addEventListener("click", async () => {
        if (!connection || connection.state !== "Connected") {
            alert("You are not connected.");
            return;
        }
        const msg = messageInput.value;
        if (msg.trim()) {
            try {
                await connection.invoke("SendMessage", username, msg);
                messageInput.value = "";
            } catch (err) {
                console.error(err);
            }
        }
    });

    messageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendBtn.click();
    });

    fileBtn.addEventListener("click", () => fileInput.click());

    // File Preview Elements
    const filePreviewArea = document.getElementById("filePreviewArea");
    const previewItems = document.getElementById("previewItems");
    const sendFilesBtn = document.getElementById("sendFilesBtn");
    const clearPreviewBtn = document.getElementById("clearPreviewBtn");
    let pendingFiles = [];

    // When files are selected, show preview instead of uploading immediately
    fileInput.addEventListener("change", (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        pendingFiles = files;
        previewItems.innerHTML = "";

        files.forEach((file, index) => {
            const item = document.createElement("div");
            item.className = "preview-item";

            // Create preview based on type
            if (file.type.startsWith("image/")) {
                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                img.className = "preview-thumb";
                item.appendChild(img);
            } else if (file.type.startsWith("video/")) {
                const video = document.createElement("video");
                video.src = URL.createObjectURL(file);
                video.className = "preview-thumb";
                video.muted = true;
                item.appendChild(video);
            } else {
                const icon = document.createElement("div");
                icon.className = "preview-icon";
                icon.textContent = "📄";
                item.appendChild(icon);
            }

            const info = document.createElement("div");
            info.className = "preview-info";
            info.innerHTML = `<span class="filename">${file.name}</span><span class="filesize">${formatSize(file.size)}</span>`;
            item.appendChild(info);

            previewItems.appendChild(item);
        });

        filePreviewArea.style.display = "block";
        fileInput.value = "";
    });

    // Clear preview
    clearPreviewBtn.addEventListener("click", () => {
        pendingFiles = [];
        previewItems.innerHTML = "";
        filePreviewArea.style.display = "none";
    });

    // Send files with progress
    sendFilesBtn.addEventListener("click", async () => {
        if (pendingFiles.length === 0) return;

        // Hide preview area first
        filePreviewArea.style.display = "none";

        // Upload each file with progress (non-blocking, runs in background)
        for (const file of pendingFiles) {
            uploadFileWithProgress(file);
        }
        pendingFiles = [];
    });

    function uploadFileWithProgress(file) {
        const formData = new FormData();
        formData.append("files", file);
        
        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
        if (token) formData.append("__RequestVerificationToken", token);

        // Create a local "uploading" message for the sender
        const uploadMsgId = "upload-" + Date.now() + "-" + Math.random();
        const uploadDiv = document.createElement("div");
        uploadDiv.className = "message self uploading";
        uploadDiv.id = uploadMsgId;
        uploadDiv.innerHTML = `
            <div class="user">${username}</div>
            <div class="content">
                <div class="upload-preview">
                    ${file.type.startsWith("image/") ? `<img src="${URL.createObjectURL(file)}" class="chat-image" />` : `<span class="file-icon">📎</span>`}
                </div>
                <div class="upload-info">
                    <span class="filename">${file.name}</span>
                    <div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                    <span class="progress-text">0%</span>
                </div>
            </div>
        `;
        messagesList.appendChild(uploadDiv);
        scrollToBottom();

        // Use XMLHttpRequest for progress tracking
        const xhr = new XMLHttpRequest();

        xhr.upload.addEventListener("progress", (e) => {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                const msgDiv = document.getElementById(uploadMsgId);
                if (msgDiv) {
                    msgDiv.querySelector(".progress-fill").style.width = percent + "%";
                    msgDiv.querySelector(".progress-text").textContent = percent + "%";
                }
            }
        });

        xhr.addEventListener("load", async () => {
            const msgDiv = document.getElementById(uploadMsgId);
            if (xhr.status >= 200 && xhr.status < 300) {
                try {
                    const result = JSON.parse(xhr.responseText);
                    if (result && result.length > 0) {
                        const item = result[0];
                        // Remove uploading message
                        if (msgDiv) msgDiv.remove();
                        // Now broadcast to everyone (including self) via SignalR
                        await connection.invoke("SendFile", username, item.name, item.url, item.type, item.size);
                    }
                } catch (err) {
                    console.error("Parse error", err);
                    if (msgDiv) {
                        msgDiv.querySelector(".progress-text").textContent = "Error";
                        msgDiv.classList.add("error");
                    }
                }
            } else {
                if (msgDiv) {
                    msgDiv.querySelector(".progress-text").textContent = "Failed";
                    msgDiv.classList.add("error");
                }
            }
        });

        xhr.addEventListener("error", () => {
            const msgDiv = document.getElementById(uploadMsgId);
            if (msgDiv) {
                msgDiv.querySelector(".progress-text").textContent = "Error";
                msgDiv.classList.add("error");
            }
        });

        xhr.open("POST", "?handler=Upload");
        xhr.send(formData);
    }

    emojiBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent closing immediately
        emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
    });

    document.body.addEventListener('click', (e) => {
         if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
             emojiPicker.style.display = 'none';
         }
    });

    emojiPicker.addEventListener('emoji-click', event => {
        messageInput.value += event.detail.unicode;
        messageInput.focus();
    });

    // Helpers
    function updateUserList(users) {
        usersList.innerHTML = "";
        userCount.textContent = users.length;
        users.forEach(u => {
            const li = document.createElement("li");
            li.textContent = u === username ? `${u} (You)` : u;
            li.className = u === username ? "current-user" : "";
            usersList.appendChild(li);
        });
    }

    function addMessage(user, msg) {
        const div = document.createElement("div");
        div.className = `message ${user === username ? "self" : "other"}`;
        div.innerHTML = `
            <div class="user">${user}</div>
            <div class="content">${escapeHtml(msg)}</div>
        `;
        messagesList.appendChild(div);
        scrollToBottom();
    }

    function addSystemMessage(msg) {
        const div = document.createElement("div");
        div.className = "message system";
        div.innerHTML = `<div class="content">${msg}</div>`;
        messagesList.appendChild(div);
        scrollToBottom();
    }

    function addFileMessage(user, fileName, url, type, size) {
        const div = document.createElement("div");
        div.className = `message ${user === username ? "self" : "other"}`;
        
        let preview = "";
        let downloadBtn = `<a href="${url}" download="${fileName}" class="download-btn">⬇️ Download (${formatSize(size)})</a>`;
        
        if (type.startsWith("image/")) {
            preview = `<img src="${url}" alt="${fileName}" class="chat-image" />`;
        } else if (type.startsWith("video/")) {
            preview = `<video src="${url}" controls class="chat-video"></video>`;
        } else if (type.startsWith("audio/")) {
            preview = `<audio src="${url}" controls class="chat-audio"></audio>`;
        } else {
            preview = `<div class="file-preview-icon">📄</div><span class="file-name">${fileName}</span>`;
        }

        div.innerHTML = `
            <div class="user">${user}</div>
            <div class="content file-content">
                <div class="file-preview">${preview}</div>
                ${downloadBtn}
            </div>
        `;
        messagesList.appendChild(div);
        scrollToBottom();
    }

    function scrollToBottom() {
        messagesList.scrollTop = messagesList.scrollHeight;
    }

    function escapeHtml(text) {
        if (!text) return text;
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    function formatSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const types = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + types[i];
    }
</script>

@Html.AntiForgeryToken()
